# Домашнее задание к занятию «Резервное копирование баз данных» - Крюков Егор

### Задание 1. Резервное копирование

### Кейс
Финансовая компания решила увеличить надёжность работы баз данных и их резервного копирования. 

Необходимо описать, какие варианты резервного копирования подходят в случаях: 

1.1. Необходимо восстанавливать данные в полном объёме за предыдущий день.

1.2. Необходимо восстанавливать данные за час до предполагаемой поломки.

1.3.* Возможен ли кейс, когда при поломке базы происходило моментальное переключение на работающую или починенную базу данных.

*Приведите ответ в свободной форме.*

---
# Решение

## 1.1 Необходимо восстанавливать данные в полном объёме за предыдущий день.

Для решения задачи резервного копирования базы данных финансовой компании рассмотрим два сценария:

1. **Полное резервное копирование (Full Backup)**  
  Ежедневно создаётся полная копия всей базы данных в фиксированное время, например, ночью, когда нагрузка минимальна.  
   - **Преимущества:**  
     - Простота восстановления: достаточно восстановить последнюю полную копию.  
     - Гарантируется целостность данных на момент создания копии.  
   - **Недостатки:**  
     - Требует значительных ресурсов (дискового пространства и времени) для создания копии.  
     - Может быть неэффективно для очень больших баз данных.  

2. **Инкрементное или дифференциальное копирование в дополнение к полному**  
  Полная копия создаётся раз в неделю (например, в воскресенье), а ежедневно сохраняются только изменения.  
   - **Преимущества:**  
     - Экономия пространства и времени по сравнению с ежедневным полным копированием.  
     - Возможность восстановления на конец дня с использованием полной копии и последней инкрементной копии.  
   - **Недостатки:**  
     - Все также требуется место для хранения полной копии и инкрементов, но по временеи инкремент делается быстрее

Для финансовой компании с высокими требованиями к надёжности предпочтительно использовать **ежедневное полное резервное копирование** в ночное время с хранением копий на нескольких распределенных хранилищах. Это минимизирует риск потери данных и упрощает восстановление. Если объём данных велик, можно скомбинировать еженедельное полное копирование с ежедневным инкрементным.


---
## 1.2 Необходимо восстанавливать данные за час до предполагаемой поломки.

Для решения этой задачи можно рассмотреть три варианта:

1. **Point-in-Time Recovery (PITR)**  
  Используется комбинация полной резервной копии и логов транзакций (WAL для PostgreSQL, transaction logs для SQL Server). Полная копия восстанавливается, а затем применяются логи транзакций до нужного момента времени.  
   - **Преимущества:**  
     - Позволяет восстановить данные на любой момент времени, включая час до сбоя.  
     - Высокая точность восстановления.  
   - **Недостатки:**  
     - Требует настройки непрерывного архивирования логов транзакций.  
     - Увеличивает сложность управления и требует больше места для хранения логов.  

2. **Частое инкрементное копирование с высокой частотой**  
  Полная копия создаётся периодически (например, раз в день), а инкрементные копии — каждый час или чаще.  
   - **Преимущества:**  
     - Позволяет восстановить данные на момент последней инкрементной копии, что может быть достаточно близко к часу до сбоя.  
     - Меньше нагрузки на систему, чем при PITR, если логи транзакций не используются.  
   - **Недостатки:**  
     - Восстановление ограничено моментами создания инкрементных копий, например, нельзя восстановить данные на 14:07, если копии создаются в 14:00 и 14:15.  
     - Может потребовать значительного пространства для хранения частых копий.  

3. **Репликация с отложенным применением (Delayed Replication)**  
  Настраивается реплика базы данных, которая отстаёт от основной на фиксированное время (к примеру на час). Если происходит сбой, данные восстанавливаются с реплики.  
   - **Преимущества:**  
     - Позволяет восстановить данные, близкие к нужному моменту, без сложного анализа логов.  
     - Может использоваться как дополнительная защита от ошибок (например, случайного удаления данных).  
   - **Недостатки:**  
     - Требует дополнительной инфраструктуры (сервер для реплики).  
     - Не всегда позволяет восстановить данные на произвольный момент времени.  
**Рекомендация:** Для восстановления данных за час до поломки оптимально использовать **Point-in-Time Recovery (PITR)**, так как это обеспечивает максимальную гибкость и точность восстановления. Для этого нужно настроить ежедневное полное копирование и непрерывное архивирование логов транзакций с частотой 5–15 минут. В качестве дополнительной меры можно настроить отложенную репликацию с задержкой 1 час для быстрого восстановления в критических ситуациях.


---

### Задание 2. PostgreSQL

2.1. С помощью официальной документации приведите пример команды резервирования данных и восстановления БД (pgdump/pgrestore).

2.1.* Возможно ли автоматизировать этот процесс? Если да, то как?

*Приведите ответ в свободной форме.*

---
# Решение

Для выполнения резервного копирования и восстановления базы данных в PostgreSQL используются утилиты `pg_dump` и `pg_restore`, которые описаны в официальной документации (https://www.postgresql.org/docs/current/backup-dump.html). Примеры команд для резервного копирования и восстановления базы данных.


### Резервное копирование базы данных с помощью `pg_dump`

Создать резервную копию базы данных для последующего восстановления.

**Пример команды:**

```bash
pg_dump -U postgres -F c -f backup_file.dump mydatabase
```

**Пояснения:**
- `-U postgres`: Указывает пользователя базы данных (в данном случае `postgres`). Можно заменить на другого пользователя с правами доступа.
- `-F c`: Формат резервной копии — `custom` (сжатый двоичный формат, подходящий для `pg_restore`).
- `-f backup_file.dump`: Имя файла, в который сохраняется резервная копия.
- `mydatabase`: Имя базы данных, которую нужно сохранить.


**Пример с указанием хоста и порта:**

```bash
pg_dump -U postgres -h localhost -p 5432 -F c -f backup_file.dump mydatabase
```

В результате будет создан файл `backup_file.dump`, содержащий полную резервную копию базы `mydatabase`.

---

### 2.2. Восстановление базы данных с помощью `pg_restore`

**Пример команды:**

```bash
pg_restore -U postgres -d mydatabase --create --verbose backup_file.dump
```

**Пояснения:**
- `-U postgres`: Указывает пользователя базы данных.
- `-d mydatabase`: Целевая база данных для восстановления. Если база не существует, то с флагом `--create` её можно создать.
- `--create`: Создаёт базу данных с именем, указанным в резервной копии, если она ещё не существует.
- `--verbose`: Выводит подробные сообщения о процессе восстановления.
- `backup_file.dump`: Файл резервной копии, созданный `pg_dump`.


**Пример восстановления на другой сервер:**

```bash
pg_restore -U postgres -h remote_host -p 5432 -d mydatabase --create --verbose backup_file.dump
```


В результате бд `mydatabase` восстанавливается из файла `backup_file.dump` с сохранением всех объектов (таблиц, индексов, данных и т.д.).

---


### Задание 3. MySQL

3.1. С помощью официальной документации приведите пример команды инкрементного резервного копирования базы данных MySQL. 

3.1.* В каких случаях использование реплики будет давать преимущество по сравнению с обычным резервным копированием?

*Приведите ответ в свободной форме.*

---
# Решение
### 3.1. Инкрементное резервное копирование базы данных MySQL

Для выполнения инкрементного резервного копирования базы данных MySQL используется механизм бинарных логов (binary logs), который позволяет сохранять изменения, произошедшие после полного резервного копирования. Согласно официальной документации MySQL (https://dev.mysql.com/doc/refman/8.0/en/backup-and-recovery.html и https://dev.mysql.com/doc/refman/8.0/en/binary-log.html), инкрементное копирование реализуется через включение бинарного логирования и последующее сохранение этих логов. Ниже приведён пример команды и процесса для инкрементного резервного копирования.

---

### Подготовка
1. **Включить бинарное логирование** (в `my.cnf` или `my.ini`):
   ```ini
   [mysqld]
   log_bin = /var/log/mysql/mysql-bin.log
   server-id = 1
   ```
   Затем перезапустить MySQL:
   ```bash
   sudo systemctl restart mysql
   ```

2. **Создать полную резервную копию** (это будет основой для инкрементного копирования):
   ```bash
   mysqldump -u root -p --single-transaction --flush-logs --master-data=2 --all-databases > full_backup.sql
   ```

---

### Команды для инкрементного копирования

1. **Сохранить текущий бинарный лог** (например, `mysql-bin.01`):
   ```bash
   mysqlbinlog /var/log/mysql/mysql-bin.01 > incremental_backup.sql
   ```

2. **Сохранить бинарный лог за определённый период** (например, за 23 апреля 2025):
   ```bash
   mysqlbinlog --start-datetime="2025-04-23 00:00:00" --stop-datetime="2025-04-23 23:59:59" /var/log/mysql/mysql-bin.01 > incremental_backup_2025-04-23.sql
   ```

3. **Ротация логов** (закрыть текущий лог и начать новый):
   ```bash
   mysql -u root -p -e "FLUSH BINARY LOGS;"
   ```

4. **Проверить доступные бинарные логи** (чтобы выбрать нужный):
   ```bash
   mysql -u root -p -e "SHOW BINARY LOGS;"
   ```

Далее можно насторить `cron` для ежедневного копирования

---
